<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dust Days: Overwhelmed</title>
<style>
body {margin:0;background:#111;color:#eee;font-family:'Courier New',monospace;display:flex;justify-content:center;align-items:center;min-height:100vh;}
#game {width:90%; max-width:900px; background:#222; padding:20px; border-radius:10px;}
h1{text-align:center; letter-spacing:2px;margin-bottom:15px;}
#story{white-space:pre-line;margin-bottom:15px;min-height:400px;line-height:1.6;}
#odditiesInput{width:100%;padding:10px;border:none;border-radius:5px;margin-bottom:10px;}
button{padding:10px 20px;border:none;border-radius:5px;background:#555;color:#fff;cursor:pointer;margin-right:5px;}
button:hover{background:#777;}
#feedback{color:#f66;font-weight:bold;text-align:center;margin-top:10px;}
#timer{color:#ffcc00;font-weight:bold;text-align:center;margin-bottom:10px;}
.hidden{display:none;}
</style>
</head>
<body>
<div id="game">

<!-- START SCREEN -->
<div id="startScreen">
<h1>Dust Days</h1>
<p style="text-align:center;">The day begins like any other.<br>It will not stay that way.</p>
<div style="text-align:center;"><button id="startBtn">Start</button></div>
</div>

<!-- PLAY AREA -->
<div id="playArea" class="hidden">
<div id="timer">Time: 180s</div>
<div id="story"></div>
<input id="odditiesInput" placeholder="What seemed off?">
<div style="text-align:center;">
<button id="submitBtn">Submit</button>
<button id="nextBtn" class="hidden">Next</button>
</div>
<p id="feedback"></p>
</div>

<!-- END SCREEN -->
<div id="endScreen" class="hidden">
<h2 id="endingTitle" style="text-align:center;"></h2>
<p id="endingText" style="white-space:pre-line; text-align:center;"></p>
<div style="text-align:center;">
<button id="restartBtn">Restart</button>
</div>
</div>
</div>

<script>
// SYNONYMS FOR WIDE ANSWER CHECK
const synonyms = {
  crow:["bird","raven","blackbird"],
  lamppost:["lamp","streetlight","light"],
  swing:["chains","seat","playground"],
  pavement:["road","path","sidewalk"],
  reflection:["mirror","glass","window"],
  bag:["bin","rubbish","plastic"],
  curtain:["drape","window"],
  door:["entrance","shopdoor"]
};

// STORY PARAGRAPHS WITH SUBTLE ANOMALIES
const storyParagraphs = [
  { text:"The kettle clicked off just as I stepped away. Steam swirled lazily above the rim. The cupboard stared back at me, empty yet somehow expectant. Outside, the road shimmered with morning dust, and a distant hum ran through the air.", oddities:[] },
  { text:"The pavement outside was cracked and dusty, a network of faint fissures like veins. Shadows leaned over them, stretching unnaturally with the sun. I walked slowly, noticing a small ripple in the concrete that had not been there yesterday.", oddities:["pavement rippled"] },
  { text:"At the junction a lamppost leaned a little, humming softly, as if it remembered some tune. A bird perched atop, staring longer than any bird should. Its shadow flickered oddly on the road, twitching out of sync with the movement of leaves.", oddities:["lamppost humming","bird stared too long"] },
  { text:"I passed the small park. The swings were still, though a chain whispered once when the wind touched it. The benches sagged faintly, and the grass smelled faintly of dust and something sour beneath. A shadow moved behind the trees, just at the edge of vision.", oddities:["swing chain whispered","shadow behind trees"] },
  { text:"A crow watched from the fence as I crossed toward the bakery. Its black eyes glinted unnaturally. The wooden fence warped slightly, creaking a note that was almost a word. The air felt heavier here, like breathing through thick cloth.", oddities:["crow stared too long","fence warped"] },
  { text:"The door to the shop resisted before opening. A soft click echoed even after it swung back. The smell of flour hit first, then something else lingered beneath it, sweet and bitter at once. My reflection in the glass seemed a half-second behind my movement.", oddities:["door resisted","reflection lagged"] },
  { text:"The shelves looked full but light somehow. Loaves sat upright, crusts gleaming unnaturally. A coin rolled under the counter though no one had touched it. I wondered if the light itself was thinner here, diffused oddly, slipping through the gaps.", oddities:["shelves hollow","coin rolled alone"] },
  { text:"Back on the road, a bin bag twitched once, then went still. The lamppost hummed again. A leaf drifted upward against the wind, lingering in the air longer than it should. My shoes scuffed the dust, but no mark remained behind me.", oddities:["bag twitched","leaf lingered"] }
];

// GAME VARIABLES
let rounds=[], missed={}, current=0, baseTime=30, timerInterval, overallTime=180, overallInterval;

// SHUFFLE HELPER
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}

// PICK RANDOM ANOMALIES & CREATE ROUNDS
function pickRandomAnomalies() {
  return storyParagraphs.map(p=>({...p, displayedOddities: []}));
}

function createRounds() {
  const shuffledParas = shuffle([...storyParagraphs]);
  const rounds = [];
  let i = 0;

  while(i < shuffledParas.length){
    let paras=[], wordCount=0;
    while(i < shuffledParas.length && wordCount < 200){ // 200+ words per section
      paras.push({...shuffledParas[i]});
      wordCount += shuffledParas[i].text.split(" ").length;
      i++;
    }

    // Randomly assign up to 3 anomalies
    let allAnoms = paras.flatMap(p=>p.oddities);
    allAnoms = shuffle(allAnoms).slice(0,3);
    let count=0;
    paras.forEach(p=>{
      p.displayedOddities=[];
      if(count<allAnoms.length && p.oddities.length>0){
        p.displayedOddities.push(allAnoms[count]);
        count++;
      }
    });

    rounds.push({paragraphs:paras});
  }
  return rounds;
}

// START GAME
function startGame(){
  document.getElementById("startScreen").classList.add("hidden");
  document.getElementById("endScreen").classList.add("hidden");
  document.getElementById("playArea").classList.remove("hidden");

  rounds = createRounds();
  current=0; missed={}; baseTime=30; overallTime=180;

  startOverallTimer();
  showRound();
}

// SHOW ROUND
function showRound(){
  const round = rounds[current];
  let parasToShow = round.paragraphs.map(p=>p.text).join("\n\n");

  // Amplify missed anomalies or invalid previous guesses
  round.paragraphs.forEach(p=>{
    p.displayedOddities.forEach(o=>{
      if((missed[o]||0)>0){
        parasToShow += `\n\nA subtle echo of the ${o} flickers again.`;
      }
    });
  });

  round.displayedOddities = round.paragraphs.flatMap(p=>p.displayedOddities);

  document.getElementById("story").innerText = parasToShow;
  document.getElementById("odditiesInput").value="";
  document.getElementById("feedback").innerText="";
  document.getElementById("nextBtn").classList.add("hidden");
  document.getElementById("submitBtn").classList.remove("hidden");

  startRoundTimer(baseTime);
}

// ROUND TIMER
function startRoundTimer(seconds){
  clearInterval(timerInterval);
  let time=seconds;
  document.getElementById("timer").innerText="Time: "+overallTime+"s";
  timerInterval=setInterval(()=>{
    time--;
    overallTime--;
    document.getElementById("timer").innerText="Time: "+overallTime+"s";
    if(time<=0){
      clearInterval(timerInterval);
      handleMissedRound();
    }
    if(overallTime<=0){
      clearInterval(timerInterval);
      clearInterval(overallInterval);
      gameOver("Time ran out. The dust consumes everything in its path.");
    }
  },1000);
}

// OVERALL TIMER
function startOverallTimer(){
  clearInterval(overallInterval);
  overallInterval=setInterval(()=>{
    overallTime--;
    document.getElementById("timer").innerText="Time: "+overallTime+"s";
    if(overallTime<=0){
      clearInterval(overallInterval);
      gameOver("Time ran out. The dust consumes everything in its path.");
    }
  },1000);
}

// HANDLE MISSED ROUND
function handleMissedRound(){
  const round=rounds[current];
  round.displayedOddities.forEach(o=>{
    missed[o]=(missed[o]||0)+1;
    baseTime=Math.max(10,baseTime-2);
  });
  document.getElementById("feedback").innerText="You waited too long. The world moves on without you.";
  nextRoundOrOver();
}

// AI GRADING
function fakeAIGrade(answers, round){
  answers=answers.toLowerCase();
  let missedList=[], invalidInputs=[];
  const words = answers.split(/[\s,]+/);

  round.displayedOddities.forEach(o=>{
    const oWords=o.toLowerCase().split(" ");
    const extra = synonyms[oWords[0]]||[];
    const all=[...oWords,...extra];
    const match = all.some(word=>words.includes(word));
    if(!match){
      missedList.push(o);
      missed[o]=(missed[o]||0)+1;
      baseTime=Math.max(10,baseTime-2);
    } else {
      missed[o]=0;
    }
  });

  // Detect invalid inputs
  words.forEach(w=>{
    let isValid=false;
    round.displayedOddities.forEach(o=>{
      const oWords=o.toLowerCase().split(" ");
      const extra = synonyms[oWords[0]]||[];
      const all=[...oWords,...extra];
      if(all.includes(w)) isValid=true;
    });
    if(!isValid && w.length>0) invalidInputs.push(w);
  });

  // Amplify for invalid inputs
  if(invalidInputs.length>0){
    round.paragraphs.forEach(p=>{
      const extras = shuffle(p.oddities).slice(0,1);
      p.displayedOddities.push(...extras);
    });
  }

  if(missedList.length===0) return "You saw it all. Nothing slipped by.";
  return "You missed: "+missedList.join(", ");
}

// END ROUND / NEXT
function nextRoundOrOver(){
  clearInterval(timerInterval);
  document.getElementById("submitBtn").classList.add("hidden");
  document.getElementById("nextBtn").classList.remove("hidden");
}

document.getElementById("submitBtn").onclick = ()=>{
  clearInterval(timerInterval);
  const answers=document.getElementById("odditiesInput").value;
  const round=rounds[current];
  const result=fakeAIGrade(answers,round);
  document.getElementById("feedback").innerText=result;
  nextRoundOrOver();
};

document.getElementById("nextBtn").onclick = ()=>{
  current++;
  if(current>=rounds.length){
    // Generate new round for continuous play
    rounds.push(...createRounds());
  }
  showRound();
};

// END SCREEN
function gameOver(message){
  clearInterval(timerInterval);
  clearInterval(overallInterval);
  document.getElementById("playArea").classList.add("hidden");
  document.getElementById
